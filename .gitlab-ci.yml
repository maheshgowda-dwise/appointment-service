# GitLab CI/CD pipeline for building and deploying the backend core service

stages:
  - build  # Only one stage for now

variables:
  IMAGE_TAG: "development"  # Docker image tag for this environment
  IMAGE_NAME: "be-apnt-service"  # Docker image name
  ECR_REGISTRY: "380617913903.dkr.ecr.ap-south-1.amazonaws.com"  # AWS ECR endpoint
  K8S_NAMESPACE: "dev"
  K8S_DEPLOYMENT: "appointment"
  WEBHOOK_URL: "https://im.ltz.one/hooks/6pyc1eb8ob8ezxrny4myw3scga"


build-and-push:
  stage: build
  script:
    # ğŸš€ Start notification with full deployment metadata
    - |
      curl -X POST $WEBHOOK_URL \
        -H "Content-Type: application/json" \
        -d "{
              \"text\": \"ğŸš€ *Deployment Started*\n\n| Key | Value |\n|-----|-------|\n| ğŸ“¦ Service | $K8S_DEPLOYMENT |\n| ğŸ“ Namespace | $K8S_NAMESPACE |\n| ğŸ”€ Branch | $CI_COMMIT_BRANCH |\n| ğŸ§‘â€ğŸ’» Author | $GITLAB_USER_NAME |\n| ğŸ“ Commit | <$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|$CI_COMMIT_SHORT_SHA> - $CI_COMMIT_MESSAGE |\n| ğŸ”— Pipeline | <$CI_PIPELINE_URL|View Pipeline> |\n\nâ³ *Status:* In Progress...\"}"



    # ğŸ› ï¸ Set Git identity for automated commits and pushes
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"

    
    # ğŸ§ª Compile the Java application, skip unit tests for CI speed
    - mvn clean install -DskipTests

    # ğŸ” Authenticate Docker with AWS ECR using IAM credentials
    - aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin $ECR_REGISTRY

    # ğŸ³ Build the Docker image from current directory and tag it
    - docker build --no-cache -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG . --platform linux/amd64

    # ğŸ“¤ Push the built Docker image to the specified ECR repository
    - docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG

    # âœ… Restart the Kubernetes deployment
    - kubectl rollout restart deployment/$K8S_DEPLOYMENT -n $K8S_NAMESPACE
  
    # âœ… Minimal success notification
    - |
      curl -X POST $WEBHOOK_URL \
        -H "Content-Type: application/json" \
        -d "{
              \"text\": \"âœ… *$K8S_DEPLOYMENT* successfully deployed to *$K8S_NAMESPACE* environment! ğŸ‰\"}"
              
  after_script:
    # âŒ Minimal failure notification
    - |
      if [ "$CI_JOB_STATUS" != "success" ]; then
        curl -X POST $WEBHOOK_URL \
          -H "Content-Type: application/json" \
          -d "{
                \"text\": \"âŒ *$K8S_DEPLOYMENT* deployment failed in *$K8S_NAMESPACE* environment. Please check the pipeline. ğŸš¨\"}"
      fi


  # âœ… Run only when:
  # - manually triggered from UI (CI_PIPELINE_SOURCE == web)
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - when: never
