#!/bin/bash

# Safe force-sync script to update Dev-K8s from development
# Preserves selected files and authenticates with GitLab using token

set -e

SOURCE_BRANCH="development"
TARGET_BRANCH="Dev-K8s"
REPO_URL="https://git.lifetrenz.com/novel/his-ehr/be/appointment-service.git"
PRESERVE_FILES=("safe-merge.sh" "Dockerfile" "pom.xml" ".gitlab-ci.yml" "src/main/resources/bootstrap.yml")

echo "ğŸ“Œ Starting safe merge process..."

# ğŸ” Inject GitLab token dynamically for all Git commands
echo "ğŸ” Setting Git credential helper for token auth"
git config --global credential.helper "!f() { echo username=gitlab-ci; echo password=$GIT_TOKEN; }; f"

# ğŸ” Ensure remote origin uses the tokenized HTTPS URL
echo "ğŸ” Forcing Git remote to use token"
git config --unset-all remote.origin.url || true
git config --add remote.origin.url "https://${GIT_TOKEN}@${REPO_URL#https://}"
echo "âœ… Remote set:"
git remote -v

# ğŸ§¹ Clean working directory before switching branches
echo "ğŸ§¹ Cleaning working directory..."
git reset --hard
git clean -fd

# ğŸ”„ Switch to target branch
echo "ğŸ”„ Checking out branch: $TARGET_BRANCH"
git checkout "$TARGET_BRANCH"

# Re-set remote again after branch switch (sometimes Git overwrites it)
git config --unset-all remote.origin.url || true
git config --add remote.origin.url "https://${GIT_TOKEN}@${REPO_URL#https://}"

echo "ğŸ“¥ Pulling latest changes for $TARGET_BRANCH"
git pull origin "$TARGET_BRANCH"

# ğŸ” Fetch latest source branch
echo "ğŸšš Fetching source branch: $SOURCE_BRANCH"
git fetch origin "$SOURCE_BRANCH:$SOURCE_BRANCH"

# ğŸ›¡ï¸ Backup preserved files
echo "ğŸ›¡ï¸ Backing up preserved files..."
for file in "${PRESERVE_FILES[@]}"; do
  if [ -f "$file" ]; then
    cp "$file" "$file.bak"
    echo "   ğŸ”„ Backed up: $file"
  fi
done

# ğŸ’¥ Hard reset to match source branch
echo "ğŸ’¥ Resetting $TARGET_BRANCH to $SOURCE_BRANCH"
git reset --hard "origin/$SOURCE_BRANCH"

# â™»ï¸ Restore preserved files
echo "â™»ï¸ Restoring preserved files..."
for file in "${PRESERVE_FILES[@]}"; do
  if [ -f "$file.bak" ]; then
    mv "$file.bak" "$file"
    git add "$file"
    echo "   âœ… Restored: $file"
  fi
done

# ğŸ“¦ Commit restored files
echo "ğŸ“¦ Committing restored files..."
git commit -m "Force-sync with development and restore preserved files" || echo "âœ… No changes to commit"

# ğŸš€ Push changes
echo "ğŸš€ Pushing to remote branch: $TARGET_BRANCH"
git push --force origin "$TARGET_BRANCH"

# ğŸ“¦ Pop stash if it exists
echo "ğŸ“¦ Restoring stashed changes (if any)..."
git stash pop || echo "âœ… No stash to apply"

echo "âœ… Safe merge completed successfully!"